<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">

<head>
    <title>FSSystem</title>
</head>

<body>
    <div data-role="page" id="VFSConfigurationPage" class="page type-interior pluginConfigurationPage fullWidthContent">
        <div data-role="content">
            <div class="content-primary">
                <form id="vfsConfigForm">
                    <div class="sectionTitle">路径映射配置</div>

                    <div class="verticalSection">
                        <div class="inputContainer">
                            <label class="inputLabel" for="BaseFolder">基础文件夹 (Base Folder)</label>
                            <input is="emby-input" type="text" id="BaseFolder" label="基础文件夹:" />
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel" for="LinkPath">链接路径 (Link Path)</label>
                            <input is="emby-input" type="text" id="LinkPath" label="链接路径:" />
                        </div>
                        <button id="btnAddMapping" is="emby-button" type="button" class="raised button-cancel block">
                            <span>添加至列表</span>
                        </button>
                    </div>

                    <div class="verticalSection">
                        <div class="sectionTitle">已添加的内容</div>
                        <div id="vfsMappingList" class="paperList"></div>
                    </div>

                    <div style="margin-top: 2em;">
                        <button is="emby-button" type="submit" class="raised button-submit block">
                            <span>保存配置</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            if (typeof VFSConfig == 'undefined') {

                const VFSConfig = {
                    pluginId: "48e252dc-232f-87b3-9169-455037912e46",
                    mappings: [],

                    // 初始化：绑定页面事件
                    init: (page) => {
                        VFSConfig.load();

                        // 绑定“添加”按钮
                        page.querySelector('#btnAddMapping').addEventListener('click', VFSConfig.addMapping);

                        // 绑定“表单保存”
                        page.querySelector('#vfsConfigForm').addEventListener('submit', (e) => {
                            e.preventDefault();
                            VFSConfig.save();
                        });
                    },

                    // 从服务器加载配置
                    load: () => {
                        Dashboard.showLoadingMsg();
                        window.ApiClient.getPluginConfiguration(VFSConfig.pluginId).then((config) => {

                            VFSConfig.mappings = config.FileSystems || [];
                            VFSConfig.render();
                            Dashboard.hideLoadingMsg();
                        }).catch(function (error) {
                            console.error(error);
                        })
                            .finally(function () {
                                Dashboard.hideLoadingMsg();
                            });;
                    },

                    // 渲染 HTML 列表
                    render: () => {
                        const container = document.getElementById('vfsMappingList');
                        container.innerHTML = VFSConfig.mappings.map((item, index) => `
                    <div class="listItem listItem-border">
                        <div class="listItemBody">
                            <div class="listItemBodyText">${item.BaseFolder}</div>
                            <div class="listItemBodyText secondary">➜ ${item.LinkPath}</div>
                        </div>
                        <button type="button" is="emby-button" class="raised btnDelete" onclick="VFSConfig.removeMapping(${index})">
                            <i class="md-icon">delete</i>
                        </button>
                    </div>
                `).join('');
                    },

                    // 添加新映射
                    addMapping: () => {
                        const base = document.getElementById('BaseFolder');
                        const link = document.getElementById('LinkPath');
                        console.log(base, link)
                        if (base.value && link.value) {
                            VFSConfig.mappings.push({
                                BaseFolder: base.value,
                                LinkPath: link.value
                            });
                            VFSConfig.render();

                            // 清空输入
                            base.value = '';
                            link.value = '';
                        } else {
                            Dashboard.alert('请输入完整的 BaseFolder 和 LinkPath');
                        }
                    },

                    // 移除映射
                    removeMapping: (index) => {
                        VFSConfig.mappings.splice(index, 1);
                        VFSConfig.render();
                    },

                    // 保存到服务器
                    save: () => {
                        Dashboard.showLoadingMsg();
                        window.ApiClient.getPluginConfiguration(VFSConfig.pluginId).then((config) => {
                            config.FileSystems = VFSConfig.mappings;

                            window.ApiClient.updatePluginConfiguration(VFSConfig.pluginId, config).then((result) => {
                                Dashboard.processPluginConfigurationUpdateResult(result);
                            }).catch(function (error) {
                                console.error(error);
                            })
                                .finally(function () {
                                    Dashboard.hideLoadingMsg();
                                });;
                        }).catch(function (error) {
                            console.error(error);
                        })
                            .finally(function () {
                                Dashboard.hideLoadingMsg();
                            });;
                    }
                }

                // Jellyfin 页面进入时触发
                document.querySelector('#VFSConfigurationPage').addEventListener('pageshow', function () {

                    VFSConfig.init(this);
                });
            }
        </script>
    </div>
</body>

</html>
